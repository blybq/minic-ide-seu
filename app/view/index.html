<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8" />
    <title>Minisys IDE</title>
    <meta http-equiv="Content-Security-Policy" content="script-src 'self' 'unsafe-inline';" />
    <link rel="stylesheet" href="../style/index.css" />
  </head>
  <body>
    <div class="toolbar" id="toolbar">
  <div id="toolbar-icons">
    <span id="new-file" class="icon" title="æ–°å»ºæ–‡ä»¶">ğŸ“„</span>
    <span id="save" class="icon" title="ä¿å­˜æ–‡ä»¶">ğŸ’¾</span>
    <span id="save-as" class="icon" title="å¦å­˜ä¸º">ğŸ“¥</span>
    <span id="magic-click" class="icon" title="ä¸€é”®æ‰§è¡Œ">â–¶</span>
    <span id="compile" class="icon" title="ç¼–è¯‘">ğŸ”¨</span>
    <span id="assembly" class="icon" title="æ±‡ç¼–">ğŸ§©</span>
    <span id="assembly-and-link" class="icon" title="æ±‡ç¼–å¹¶é“¾æ¥">ğŸ”—</span>
    <span id="serial" class="icon" title="ä¸²å£çƒ§å½•">ğŸ”Œ</span>
  </div>
</div>
    <div class="container">
      <!-- å·¦ä¾§æ´»åŠ¨æ  -->
      <div id="activity-bar">
        <div class="activity-item active" id="activity-explorer" title="èµ„æºç®¡ç†å™¨">
          <span class="activity-icon">ğŸ“</span>
        </div>
        <div class="activity-item" id="activity-search" title="æœç´¢">
          <span class="activity-icon">ğŸ”</span>
        </div>
        <div class="activity-item" id="activity-settings" title="è®¾ç½®">
          <span class="activity-icon">âš™ï¸</span>
        </div>
      </div>
      
      <!-- ä¾§è¾¹æ é¢æ¿ -->
      <div id="sidebar-panel">
        <!-- èµ„æºç®¡ç†å™¨è§†å›¾ -->
        <div id="explorer-view" class="sidebar-view active">
          <div id="sidebar">
            <div id="sidebar-icons">
              <span id="refresh" title="åˆ·æ–°èµ„æºç®¡ç†å™¨" class="icon">ğŸ”„</span>
              <span id="newFile" title="æ–°å»ºæ–‡ä»¶" class="icon">ğŸ“„</span>
              <span id="newFolder" title="æ–°å»ºæ–‡ä»¶å¤¹" class="icon">ğŸ“</span>
              <span id="openCurFolder" title="æ‰“å¼€æ–‡ä»¶å¤¹" class="icon">ğŸ“‚</span>
            </div>
            <span id="current-path">æœªæ‰“å¼€ä»»ä½•ç›®å½•</span>
            <div id="tree-view"></div>
          </div>
        </div>
        
        <!-- æœç´¢è§†å›¾ -->
        <div id="search-view" class="sidebar-view">
          <div class="search-container">
            <div class="search-header">
              <input type="text" id="search-input" placeholder="æœç´¢å·¥ä½œåŒº..." />
            </div>
            <div id="search-results" class="search-results"></div>
          </div>
        </div>
        
        <!-- è®¾ç½®è§†å›¾ -->
        <div id="settings-view" class="sidebar-view">
          <div class="settings-container">
            <div class="settings-item" id="settings-editor">
              <span class="settings-icon">ğŸ“</span>
              <span class="settings-label">ç¼–è¾‘å™¨ä¸ªæ€§åŒ–</span>
            </div>
            <div class="settings-item" id="settings-toolchain">
              <span class="settings-icon">ğŸ”§</span>
              <span class="settings-label">å·¥å…·é“¾è®¾ç½®</span>
            </div>
          </div>
        </div>
      </div>

      <!-- ä¾§è¾¹æ æ‹–æ‹½æ¡ -->
      <div id="sidebar-dragbar" title="æ‹–åŠ¨è°ƒæ•´ä¾§è¾¹æ å®½åº¦"></div>

      <!-- å·¥ä½œåŒºï¼šç¼–è¾‘å™¨ + åˆ†å‰²æ¡ + ç»ˆç«¯ -->
      <div id="workarea">
        <div id="editor"></div>
        <!-- è®¾ç½®é¢æ¿è¦†ç›–å±‚ -->
        <div id="settings-overlay" style="display: none;">
          <div id="settings-content"></div>
        </div>
        <div id="console-dragbar" title="æ‹–åŠ¨è°ƒæ•´ç»ˆç«¯é«˜åº¦"></div>
        <div id="console">
          <div class="console-header">
            <span id="btn-maximize" class="emoji-btn" title="æ”¾å¤§/ç¼©å°">â›¶</span>
            <span id="btn-delete" class="emoji-btn" title="åˆ é™¤ç»ˆç«¯">ğŸ—‘ï¸</span>
            <span class="console-title">PowerShell</span>
          </div>
          <div id="terminal-container"></div>
        </div>
      </div>
    </div>

    <script src="../../lib/ace/ace.js"></script>
    <script src="../../lib/ace/ext-language_tools.js"></script>
    <script>
      require('../script/initAll.js')

      // å®šä¹‰ $ å‡½æ•°ç”¨äº DOM é€‰æ‹©ï¼ˆä¸ terminal.js ç­‰è„šæœ¬ä¿æŒä¸€è‡´ï¼‰
      const $ = document.querySelector.bind(document)

      // ç­‰å¾…DOMåŠ è½½å®Œæˆåå†ç»‘å®šæŒ‰é’®äº‹ä»¶
      function initConsoleButtons() {
        // åˆ é™¤ç»ˆç«¯æŒ‰é’®
        const deleteBtn = document.querySelector('#btn-delete')
        if (deleteBtn) {
          deleteBtn.onclick = () => {
            const { closeTerminal } = require('../script/terminal')
            closeTerminal()
          }
        }
        
        // æ”¾å¤§ç¼©å°æŒ‰é’® - ä½¿ç”¨äº‹ä»¶å§”æ‰˜
        const consoleHeader = document.querySelector('.console-header')
        
        if (consoleHeader) {
          // ä½¿ç”¨ window å¯¹è±¡å­˜å‚¨çŠ¶æ€ï¼Œé¿å…æ¯æ¬¡å‡½æ•°è°ƒç”¨æ—¶é‡ç½®
          if (typeof window.terminalMaximized === 'undefined') {
            window.terminalMaximized = false
          }
          
          // ç›‘æ§consoleå…ƒç´ çš„classListå’Œstyleå˜åŒ–
          const consoleEl = document.querySelector('#console')
          const editorEl = document.querySelector('#editor')
          
          // ç›‘æ§ç¼–è¾‘å™¨å…ƒç´ çš„å˜åŒ–
          if (editorEl) {
            const editorObserver = new MutationObserver((mutations) => {
              mutations.forEach((mutation) => {
                if (mutation.type === 'attributes' && mutation.attributeName === 'style') {
                  // Editor style changed - no action needed
                }
              })
            })
            editorObserver.observe(editorEl, {
              attributes: true,
              attributeOldValue: true,
              attributeFilter: ['style']
            })
          }
          
          if (consoleEl) {
            // ç›‘æ§classå˜åŒ–
            const classObserver = new MutationObserver((mutations) => {
              mutations.forEach((mutation) => {
                if (mutation.type === 'attributes' && mutation.attributeName === 'class') {
                  // Console class changed - no action needed
                }
              })
            })
            classObserver.observe(consoleEl, {
              attributes: true,
              attributeOldValue: true,
              attributeFilter: ['class']
            })
            
            // ç›‘æ§styleå±æ€§å˜åŒ–
            const styleObserver = new MutationObserver((mutations) => {
              mutations.forEach((mutation) => {
                if (mutation.type === 'attributes' && mutation.attributeName === 'style') {
                  // Console style changed - no action needed
                }
              })
            })
            styleObserver.observe(consoleEl, {
              attributes: true,
              attributeOldValue: true,
              attributeFilter: ['style']
            })
          }
          
          // ä½¿ç”¨äº‹ä»¶å§”æ‰˜å¤„ç†æŒ‰é’®ç‚¹å‡»
          consoleHeader.addEventListener('click', (e) => {
            const maximizeBtn = e.target.closest('#btn-maximize')
            if (!maximizeBtn) return
            
            e.preventDefault()
            e.stopPropagation()
            
            const consoleEl = document.querySelector('#console')
            if (!consoleEl) {
              console.error('Console element not found')
              return
            }
            
            if (!window.terminalMaximized) {
              consoleEl.classList.add('maximized')
              window.terminalMaximized = true
              maximizeBtn.textContent = 'â›¶'
              maximizeBtn.title = 'ç¼©å°'
              // æ¸…é™¤æ‰€æœ‰å†…è”æ ·å¼ï¼Œè®© CSS çš„ #console.maximized è§„åˆ™ç”Ÿæ•ˆ
              consoleEl.style.flex = ''
              consoleEl.style.height = ''
              consoleEl.style.minHeight = ''
              consoleEl.style.maxHeight = ''
            } else {
              consoleEl.classList.remove('maximized')
              window.terminalMaximized = false
              maximizeBtn.textContent = 'â›¶'
              maximizeBtn.title = 'æ”¾å¤§'
              // æ¸…é™¤æ‰€æœ‰å†…è”æ ·å¼ï¼Œè®© CSS è§„åˆ™è‡ªç„¶ç”Ÿæ•ˆ
              consoleEl.style.flex = ''
              consoleEl.style.height = ''
              consoleEl.style.minHeight = ''
              consoleEl.style.maxHeight = ''
            }
            // åœ¨æœ€å¤§åŒ–/ç¼©å°ç»ˆç«¯æ—¶ï¼Œéœ€è¦è§¦å‘ resize æ¥è®© Ace Editor è°ƒæ•´å¤§å°
            // ä½†éœ€è¦ç¡®ä¿ç¼–è¾‘å™¨å®¹å™¨æœ‰æ­£ç¡®çš„é«˜åº¦
            if (window.editor && typeof window.editor.resize === 'function') {
              setTimeout(() => {
                const editorEl = document.querySelector('#editor')
                if (editorEl && editorEl.offsetHeight > 0) {
                  window.editor.resize()
                }
              }, 100)
            } else {
              window.dispatchEvent(new Event('resize'))
            }
          })
        }
      }
      
      // å¦‚æœDOMå·²åŠ è½½ï¼Œç«‹å³æ‰§è¡Œï¼›å¦åˆ™ç­‰å¾…
      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initConsoleButtons)
      } else {
        // DOMå·²åŠ è½½ï¼Œå»¶è¿Ÿä¸€ç‚¹ç¡®ä¿æ‰€æœ‰å…ƒç´ éƒ½å·²åˆ›å»ºï¼ˆç‰¹åˆ«æ˜¯ç»ˆç«¯æŒ‰é’®å¯èƒ½åœ¨ç»ˆç«¯åˆå§‹åŒ–åæ‰åˆ›å»ºï¼‰
        setTimeout(initConsoleButtons, 200)
      }

      // æ‹–æ‹½åˆ†å‰²æ¡
      ;(function(){
        const work = document.getElementById('workarea')
        const bar  = document.getElementById('console-dragbar')
        const term = document.getElementById('console')
        let dragging = false, startY = 0, startH = 0

        bar.addEventListener('mousedown', e => {
          dragging = true
          startY = e.clientY
          startH = term.getBoundingClientRect().height
          document.body.style.cursor = 'row-resize'
          e.preventDefault()
        })

        window.addEventListener('mousemove', e => {
          if (!dragging) return
          const dy = e.clientY - startY
          const newH = Math.max(120, Math.min(work.clientHeight - 80, startH - dy))
          term.style.flexBasis = newH + 'px'
          // æ‹–æ‹½æ—¶è§¦å‘ resizeï¼Œä½†éœ€è¦ç¡®ä¿ç¼–è¾‘å™¨æœ‰æ­£ç¡®çš„é«˜åº¦
          if (window.editor && typeof window.editor.resize === 'function') {
            setTimeout(() => {
              const editorEl = document.querySelector('#editor')
              if (editorEl && editorEl.offsetHeight > 0) {
                window.editor.resize()
              }
            }, 50)
          } else {
            window.dispatchEvent(new Event('resize'))
          }
        })

        window.addEventListener('mouseup', () => {
          if (!dragging) return
          dragging = false
          document.body.style.cursor = ''
        })
      })()

      // ===== ä¾§è¾¹æ æ‹–æ‹½å®½åº¦ =====
      ;(function () {
        const sidebarPanel  = document.getElementById('sidebar-panel')
        const dragbar  = document.getElementById('sidebar-dragbar')
        // æ¢å¤ä¸Šæ¬¡å®½åº¦
        const saved = localStorage.getItem('sidebarWidth')
        if (saved && sidebarPanel) {
          const activeView = sidebarPanel.querySelector('.sidebar-view.active')
          if (activeView) activeView.style.width = saved + 'px'
        }

        let dragging = false
        let startX = 0, startW = 0

        const minW = 160
        const maxW = Math.floor(window.innerWidth * 0.6) // æœ€å¤§ 60vw

        if (dragbar) {
          dragbar.addEventListener('mousedown', (e) => {
            dragging = true
            startX = e.clientX
            const activeView = sidebarPanel.querySelector('.sidebar-view.active')
            if (activeView) startW = activeView.getBoundingClientRect().width
            document.body.style.cursor = 'col-resize'
            document.body.style.userSelect = 'none'
            e.preventDefault()
          })
        }

        window.addEventListener('mousemove', (e) => {
          if (!dragging || !sidebarPanel) return
          const dx = e.clientX - startX
          let newW = startW + dx
          newW = Math.max(minW, Math.min(maxW, newW))
          const activeView = sidebarPanel.querySelector('.sidebar-view.active')
          if (activeView) {
            activeView.style.width = newW + 'px'
            // ä¾§è¾¹æ æ‹–æ‹½æ—¶è§¦å‘ resizeï¼Œä½†éœ€è¦ç¡®ä¿ç¼–è¾‘å™¨æœ‰æ­£ç¡®çš„é«˜åº¦
            if (window.editor && typeof window.editor.resize === 'function') {
              setTimeout(() => {
                const editorEl = document.querySelector('#editor')
                if (editorEl && editorEl.offsetHeight > 0) {
                  window.editor.resize()
                }
              }, 50)
            } else {
              window.dispatchEvent(new Event('resize'))
            }
          }
        })

        window.addEventListener('mouseup', () => {
          if (!dragging) return
          dragging = false
          document.body.style.cursor = ''
          document.body.style.userSelect = ''
          if (sidebarPanel) {
            const activeView = sidebarPanel.querySelector('.sidebar-view.active')
            if (activeView) {
              const w = activeView.getBoundingClientRect().width | 0
              localStorage.setItem('sidebarWidth', String(w))
            }
          }
        })

        // åŒå‡»æŠ˜å /è¿˜åŸ
        if (dragbar) {
          let lastWidth = parseInt(saved || 250, 10)
          dragbar.addEventListener('dblclick', () => {
            if (!sidebarPanel) return
            const activeView = sidebarPanel.querySelector('.sidebar-view.active')
            if (!activeView) return
            const cur = activeView.getBoundingClientRect().width | 0
            if (cur > 20) {
              lastWidth = cur
              activeView.style.width = '0px'
            } else {
              activeView.style.width = (lastWidth || 250) + 'px'
            }
            // åŒå‡»ä¾§è¾¹æ æ—¶è§¦å‘ resizeï¼Œä½†éœ€è¦ç¡®ä¿ç¼–è¾‘å™¨æœ‰æ­£ç¡®çš„é«˜åº¦
            if (window.editor && typeof window.editor.resize === 'function') {
              setTimeout(() => {
                const editorEl = document.querySelector('#editor')
                if (editorEl && editorEl.offsetHeight > 0) {
                  window.editor.resize()
                }
              }, 50)
            } else {
              window.dispatchEvent(new Event('resize'))
            }
          })
        }

        // çª—å£å˜åŒ–æ—¶æ ¡æ­£æœ€å¤§å®½åº¦
        window.addEventListener('resize', () => {
          if (!sidebarPanel) return
          const activeView = sidebarPanel.querySelector('.sidebar-view.active')
          if (activeView) {
            const cur = activeView.getBoundingClientRect().width | 0
            const limit = Math.floor(window.innerWidth * 0.6)
            if (cur > limit) activeView.style.width = limit + 'px'
          }
        })
      })()

      require('../script/editor.js')
      require('../script/contextmenu.js')
    </script>
  </body>
</html>